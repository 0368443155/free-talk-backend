### TalkConnect - Báº£n Ä‘áº·c táº£ TÃ­nh nÄƒng Chi tiáº¿t (v1)

TÃ i liá»‡u nÃ y mÃ´ táº£ chi tiáº¿t cÃ¡c yÃªu cáº§u chá»©c nÄƒng cho PhiÃªn báº£n 1 (MVP) cá»§a TalkConnect.

## 1. ğŸ¯ Má»¥c tiÃªu v1

Táº¡o ra má»™t ná»n táº£ng (MVP) nÆ¡i ngÆ°á»i dÃ¹ng cÃ³ thá»ƒ táº¡o, khÃ¡m phÃ¡ vÃ  tham gia cÃ¡c phÃ²ng chat cÃ´ng khai (chá»‰ há»— trá»£ chat text vÃ  cÃ¡c chá»©c nÄƒng quáº£n lÃ½ cÆ¡ báº£n).

## 2. ğŸ‘¤ Äá»‘i tÆ°á»£ng NgÆ°á»i dÃ¹ng (Actors)

Guest (KhÃ¡ch): NgÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p.

Authenticated User (NgÆ°á»i dÃ¹ng): NgÆ°á»i dÃ¹ng Ä‘Ã£ Ä‘Äƒng nháº­p.

Host (Chá»§ phÃ²ng): NgÆ°á»i dÃ¹ng Ä‘Ã£ táº¡o ra phÃ²ng (lÃ  má»™t vai trÃ² cá»§a Authenticated User).

## 3. ğŸ“– Äáº·c táº£ TÃ­nh nÄƒng (Feature Specifications)

# F1: Táº¡o phÃ²ng (Room Creation)

User Story: "LÃ  má»™t NgÆ°á»i dÃ¹ng, tÃ´i muá»‘n táº¡o má»™t phÃ²ng trÃ² chuyá»‡n má»›i vá»›i cÃ¡c tÃ¹y chá»n cÆ¡ báº£n (tÃªn, ngÃ´n ngá»¯, giá»›i háº¡n) Ä‘á»ƒ ngÆ°á»i khÃ¡c cÃ³ thá»ƒ tháº¥y vÃ  tham gia."

Actor: Authenticated User

Giao diá»‡n (Äá» xuáº¥t): Má»™t Modal (cá»­a sá»• pop-up) "Táº¡o phÃ²ng má»›i".

API liÃªn quan: POST /rooms

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

NgÆ°á»i dÃ¹ng pháº£i Ä‘Äƒng nháº­p (Ä‘Æ°á»£c báº£o vá»‡ bá»Ÿi JwtAuthGuard).

Input (DTO: CreateRoomDto) pháº£i Ä‘Æ°á»£c xÃ¡c thá»±c (validate):

title: Báº¯t buá»™c, chuá»—i, tá»‘i thiá»ƒu 3 kÃ½ tá»±, tá»‘i Ä‘a 100 kÃ½ tá»±.

language: TÃ¹y chá»n, chuá»—i (vÃ­ dá»¥: 'en', 'vi', 'es').

topic: TÃ¹y chá»n, chuá»—i (vÃ­ dá»¥: 'ielts', 'gaming').

max_participants: Báº¯t buá»™c, sá»‘ nguyÃªn, tá»‘i thiá»ƒu 2, tá»‘i Ä‘a 10 (cáº¥u hÃ¬nh).

Khi thá»±c hiá»‡n thÃ nh cÃ´ng (Logic Service):

Há»‡ thá»‘ng pháº£i táº¡o má»™t record má»›i trong báº£ng Rooms.

status cá»§a phÃ²ng má»›i pháº£i Ä‘Æ°á»£c Ä‘áº·t lÃ  LIVE.

host_id cá»§a phÃ²ng má»›i pháº£i lÃ  id cá»§a ngÆ°á»i dÃ¹ng táº¡o.

Há»‡ thá»‘ng pháº£i tá»± Ä‘á»™ng táº¡o má»™t record trong RoomParticipants liÃªn káº¿t userId nÃ y vá»›i roomId má»›i, vÃ  gÃ¡n role = 'HOST'.

Há»‡ thá»‘ng pháº£i PUBLISH má»™t sá»± kiá»‡n room:created lÃªn kÃªnh Redis (Ä‘á»ƒ kÃ­ch hoáº¡t F3).

Khi thá»±c hiá»‡n tháº¥t báº¡i (Validation):

Tráº£ vá» lá»—i 400 Bad Request náº¿u input khÃ´ng há»£p lá»‡.

Tráº£ vá» lá»—i 401 Unauthorized náº¿u ngÆ°á»i dÃ¹ng chÆ°a Ä‘Äƒng nháº­p.

# F2: KhÃ¡m phÃ¡ phÃ²ng (Room Discovery)

User Story: "LÃ  má»™t Guest hoáº·c User, tÃ´i muá»‘n xem danh sÃ¡ch cÃ¡c phÃ²ng Ä‘ang hoáº¡t Ä‘á»™ng Ä‘á»ƒ tÃ´i cÃ³ thá»ƒ chá»n má»™t phÃ²ng Ä‘á»ƒ tham gia."

Actor: Guest, Authenticated User

Giao diá»‡n (Äá» xuáº¥t): Trang chá»§ (Sáº£nh chá» - Lobby) hiá»ƒn thá»‹ danh sÃ¡ch cÃ¡c phÃ²ng.

API liÃªn quan: GET /rooms

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

Endpoint nÃ y pháº£i public (khÃ´ng yÃªu cáº§u JwtAuthGuard).

Chá»‰ tráº£ vá» cÃ¡c phÃ²ng cÃ³ status = 'LIVE'.

Káº¿t quáº£ pháº£i Ä‘Æ°á»£c sáº¯p xáº¿p theo created_at DESC (phÃ²ng má»›i nháº¥t lÃªn Ä‘áº§u).

Há»— trá»£ phÃ¢n trang (Pagination):

Query params: ?page=1, ?limit=20.

Pháº£i tráº£ vá» total (tá»•ng sá»‘ phÃ²ng) vÃ  data (danh sÃ¡ch phÃ²ng).

Há»— trá»£ lá»c (Filter):

Query params: ?language=en, ?topic=gaming.

Há»‡ thá»‘ng pháº£i lá»c káº¿t quáº£ dá»±a trÃªn cÃ¡c query param nÃ y.

Pháº£i tráº£ vá» sá»‘ lÆ°á»£ng ngÆ°á»i tham gia hiá»‡n táº¡i cho má»—i phÃ²ng (nÃªn cache trong Redis Ä‘á»ƒ tá»‘i Æ°u).

# F3: Cáº­p nháº­t Sáº£nh chá» Real-time (Lobby Real-time Update)

User Story: "LÃ  má»™t User Ä‘ang á»Ÿ sáº£nh chá», tÃ´i muá»‘n danh sÃ¡ch phÃ²ng tá»± Ä‘á»™ng cáº­p nháº­t (thÃªm hoáº·c xÃ³a) ngay khi cÃ³ phÃ²ng má»›i Ä‘Æ°á»£c táº¡o hoáº·c phÃ²ng cÅ© káº¿t thÃºc, mÃ  khÃ´ng cáº§n táº£i láº¡i trang."

Actor: Authenticated User

Giao diá»‡n (Äá» xuáº¥t): Logic cá»§a component Sáº£nh chá» (RoomDiscovery.tsx).

Socket.IO liÃªn quan: Event room:list-update (Server-to-Client)

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

Client (Frontend) khi á»Ÿ Sáº£nh chá» pháº£i káº¿t ná»‘i Socket.IO vÃ  láº¯ng nghe sá»± kiá»‡n room:list-update.

Khi má»™t phÃ²ng má»›i Ä‘Æ°á»£c táº¡o (logic F1), RoomsGateway (sau khi nháº­n sá»± kiá»‡n Pub/Sub tá»« Redis) pháº£i emit sá»± kiá»‡n room:list-update cho táº¥t cáº£ client khÃ´ng á»Ÿ trong phÃ²ng (tá»©c lÃ  á»Ÿ sáº£nh chá»).

Payload: { action: 'created', room: <RoomData> }

Khi má»™t phÃ²ng káº¿t thÃºc (logic F5), RoomsGateway pháº£i emit sá»± kiá»‡n room:list-update.

Payload: { action: 'ended', room: <RoomData> }

Logic Frontend:

Khi nháº­n created, thÃªm room vÃ o Ä‘áº§u danh sÃ¡ch rooms.

Khi nháº­n ended, lá»c bá» room ra khá»i danh sÃ¡ch rooms (dá»±a trÃªn room.id).

# F4: Tham gia phÃ²ng (Join Room)

User Story: "LÃ  má»™t User, tÃ´i muá»‘n tham gia má»™t phÃ²ng tá»« Sáº£nh chá»."

Actor: Authenticated User

Giao diá»‡n (Äá» xuáº¥t): Click vÃ o nÃºt "Join" trÃªn má»™t tháº» phÃ²ng á»Ÿ Sáº£nh chá».

API liÃªn quan: POST /rooms/:roomId/join

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

NgÆ°á»i dÃ¹ng pháº£i Ä‘Äƒng nháº­p (JwtAuthGuard).

Há»‡ thá»‘ng pháº£i kiá»ƒm tra (Validation Logic 4 bÆ°á»›c):

Tá»“n táº¡i: PhÃ²ng (roomId) pháº£i tá»“n táº¡i trong CSDL.

Tráº¡ng thÃ¡i: PhÃ²ng pháº£i cÃ³ status = 'LIVE'. Náº¿u ENDED, tráº£ vá» lá»—i 404.

Bá»‹ Kick: NgÆ°á»i dÃ¹ng (userId) khÃ´ng Ä‘Æ°á»£c cÃ³ báº£n ghi RoomParticipants vá»›i is_kicked = 1 cho roomId nÃ y. Náº¿u cÃ³, tráº£ vá» lá»—i 403 Forbidden ("Báº¡n Ä‘Ã£ bá»‹ kick").

PhÃ²ng Ä‘áº§y: Äáº¿m sá»‘ lÆ°á»£ng RoomParticipants hiá»‡n táº¡i cá»§a phÃ²ng. Náº¿u sá»‘ lÆ°á»£ng >= max_participants, tráº£ vá» lá»—i 403 Forbidden ("PhÃ²ng Ä‘Ã£ Ä‘áº§y").

Khi thÃ nh cÃ´ng:

Há»‡ thá»‘ng táº¡o má»™t record RoomParticipants má»›i (vá»›i role = 'PARTICIPANT').

API tráº£ vá» 200 OK (hoáº·c 201 Created) vá»›i thÃ´ng tin phÃ²ng (hoáº·c token tham gia).

Logic Frontend (Sau khi Join thÃ nh cÃ´ng):

Chuyá»ƒn hÆ°á»›ng ngÆ°á»i dÃ¹ng Ä‘áº¿n trang /rooms/:roomId.

Trang nÃ y sáº½ emit sá»± kiá»‡n Socket.IO room:join Ä‘á»ƒ thÃ´ng bÃ¡o cho nhá»¯ng ngÆ°á»i khÃ¡c.

# F5: Rá»i phÃ²ng & Tá»± Ä‘á»™ng dá»n dáº¹p (Leave Room & Auto-Cleanup)

User Story 1: "LÃ  má»™t User trong phÃ²ng, tÃ´i muá»‘n rá»i khá»i phÃ²ng."

User Story 2: "LÃ  má»™t Host, khi tÃ´i lÃ  ngÆ°á»i cuá»‘i cÃ¹ng rá»i Ä‘i, tÃ´i muá»‘n phÃ²ng tá»± Ä‘á»™ng Ä‘Ã³ng láº¡i."

Actor: Authenticated User

Giao diá»‡n (Äá» xuáº¥t): NÃºt "Rá»i phÃ²ng".

API liÃªn quan: POST /rooms/:roomId/leave

Socket.IO liÃªn quan: handleDisconnect, @SubscribeMessage('room:leave')

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

Rá»i chá»§ Ä‘á»™ng:

NgÆ°á»i dÃ¹ng click "Rá»i phÃ²ng", frontend gá»i POST /rooms/:roomId/leave (hoáº·c socket.emit('room:leave')).

Server cáº­p nháº­t RoomParticipants (set left_at hoáº·c xÃ³a record).

Server emit('room:user-left', { userId }) cho nhá»¯ng ngÆ°á»i cÃ²n láº¡i trong phÃ²ng.

Máº¥t káº¿t ná»‘i:

RoomsGateway báº¯t sá»± kiá»‡n handleDisconnect().

Gateway pháº£i xÃ¡c Ä‘á»‹nh userId vÃ  roomId mÃ  socket nÃ y Ä‘Ã£ tham gia (lÆ°u state khi join).

Thá»±c hiá»‡n logic tÆ°Æ¡ng tá»± nhÆ° "Rá»i chá»§ Ä‘á»™ng".

Tá»± Ä‘á»™ng dá»n dáº¹p (Logic checkAndEndRoom()):

Logic nÃ y pháº£i Ä‘Æ°á»£c kÃ­ch hoáº¡t sau khi "Rá»i chá»§ Ä‘á»™ng" hoáº·c "Máº¥t káº¿t ná»‘i".

Service Ä‘áº¿m sá»‘ lÆ°á»£ng RoomParticipants cÃ²n láº¡i trong roomId (nhá»¯ng ngÆ°á»i chÆ°a left_at).

Náº¿u Count = 0:

Há»‡ thá»‘ng pháº£i cáº­p nháº­t Rooms.status = ENDED.

Há»‡ thá»‘ng pháº£i PUBLISH sá»± kiá»‡n room:ended lÃªn Redis (Ä‘á»ƒ kÃ­ch hoáº¡t F3).

Náº¿u Count > 0 VÃ€ ngÆ°á»i rá»i Ä‘i lÃ  Host:

Há»‡ thá»‘ng pháº£i chá»‰ Ä‘á»‹nh má»™t ngÆ°á»i tham gia lÃ¢u nÄƒm nháº¥t lÃ m Host má»›i (Logic v2 - v1 cÃ³ thá»ƒ bá» qua vÃ  phÃ²ng káº¿t thÃºc).

# F6: Chat vÄƒn báº£n (Text Chat)

User Story: "LÃ  má»™t User trong phÃ²ng, tÃ´i muá»‘n gá»­i vÃ  nháº­n tin nháº¯n vÄƒn báº£n Ä‘á»ƒ giao tiáº¿p vá»›i nhá»¯ng ngÆ°á»i khÃ¡c."

Actor: Authenticated User (Ä‘Ã£ tham gia phÃ²ng)

Giao diá»‡n (Äá» xuáº¥t): Khung chat trong RoomView.tsx.

API liÃªn quan: GET /rooms/:roomId/chat

Socket.IO liÃªn quan: chat:message

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

Láº¥y lá»‹ch sá»­:

Khi Frontend (RoomView) táº£i, nÃ³ pháº£i gá»i GET /rooms/:roomId/chat.

API tráº£ vá» 50 tin nháº¯n cuá»‘i cÃ¹ng (hoáº·c phÃ¢n trang).

Gá»­i tin nháº¯n:

NgÆ°á»i dÃ¹ng nháº­p tin nháº¯n vÃ  nháº¥n Enter.

Frontend emit('chat:message', { roomId, message: '...' }).

Nháº­n tin nháº¯n (Gateway Logic):

RoomsGateway báº¯t sá»± kiá»‡n chat:message.

XÃ¡c thá»±c ngÆ°á»i gá»­i (client.user.id).

LÆ°u tin nháº¯n vÃ o CSDL (RoomChatMessages).

Broadcast (client.to(roomId).emit(...)) sá»± kiá»‡n chat:message cho táº¥t cáº£ má»i ngÆ°á»i trong roomId (bao gá»“m cáº£ ngÆ°á»i gá»­i).

Payload pháº£i chá»©a thÃ´ng tin ngÆ°á»i gá»­i: { message: '...', sender: { id, username, avatar_url } }.

# F7: Quyá»n Host - Kick (Host Control - Kick)

User Story: "LÃ  má»™t Host, tÃ´i muá»‘n kick má»™t ngÆ°á»i dÃ¹ng phiá»n nhiá»…u ra khá»i phÃ²ng cá»§a tÃ´i."

Actor: Host

Giao diá»‡n (Äá» xuáº¥t): NÃºt "Kick" bÃªn cáº¡nh tÃªn ngÆ°á»i dÃ¹ng trong danh sÃ¡ch Participants.

API liÃªn quan: POST /rooms/:roomId/kick/:userId

Socket.IO liÃªn quan: room:user-kicked (Server-to-Client)

YÃªu cáº§u nghiá»‡p vá»¥ (Acceptance Criteria):

Hiá»ƒn thá»‹ (Frontend):

Frontend pháº£i kiá»ƒm tra currentUser.id === room.host_id.

Náº¿u Ä‘Ãºng, hiá»ƒn thá»‹ nÃºt "Kick" bÃªn cáº¡nh táº¥t cáº£ ngÆ°á»i tham gia khÃ¡c (trá»« chÃ­nh Host).

Gá»i API:

Khi Host click "Kick", Frontend gá»i POST /rooms/:roomId/kick/:targetUserId.

Xá»­ lÃ½ (Backend):

API (RoomsController) pháº£i báº£o vá»‡ báº±ng JwtAuthGuard.

Service (kickParticipant) pháº£i kiá»ƒm tra request.user.id (Host) cÃ³ pháº£i lÃ  host_id cá»§a phÃ²ng khÃ´ng.

Náº¿u Ä‘Ãºng, Service cáº­p nháº­t RoomParticipants cá»§a targetUserId thÃ nh is_kicked = 1.

ThÃ´ng bÃ¡o (Real-time):

Sau khi cáº­p nháº­t CSDL, RoomsGateway pháº£i emit('room:user-kicked', { userId: targetUserId }) cho táº¥t cáº£ má»i ngÆ°á»i trong phÃ²ng (bao gá»“m cáº£ ngÆ°á»i bá»‹ kick).

Xá»­ lÃ½ (Frontend):

Táº¥t cáº£ client nháº­n room:user-kicked, lá»c user Ä‘Ã³ ra khá»i danh sÃ¡ch participants.

Client cá»§a ngÆ°á»i bá»‹ kick, khi nháº­n Ä‘Æ°á»£c sá»± kiá»‡n nÃ y, pháº£i hiá»ƒn thá»‹ thÃ´ng bÃ¡o "Báº¡n Ä‘Ã£ bá»‹ kick" vÃ  tá»± Ä‘á»™ng Ä‘iá»u hÆ°á»›ng vá» Sáº£nh chá».

Logic (F4) sáº½ ngÄƒn ngÆ°á»i nÃ y tham gia láº¡i.