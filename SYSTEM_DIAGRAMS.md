# 4Talk Platform - System Architecture Diagrams

## ğŸ—ï¸ Overall System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        4Talk Platform                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Teacher    â”‚      â”‚   Student    â”‚      â”‚    Admin     â”‚  â”‚
â”‚  â”‚  Dashboard   â”‚      â”‚  Dashboard   â”‚      â”‚     CMS      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                     â”‚                     â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                               â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚   API Gateway       â”‚                      â”‚
â”‚                    â”‚   (NestJS)          â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                               â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚         â”‚                     â”‚                     â”‚           â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
â”‚    â”‚ Course  â”‚          â”‚ Payment â”‚          â”‚FreeTalk â”‚       â”‚
â”‚    â”‚ Service â”‚          â”‚ Service â”‚          â”‚ Service â”‚       â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                     â”‚                     â”‚           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                               â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚                    â”‚   PostgreSQL DB     â”‚                      â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚                  â”‚                  â”‚                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”             â”‚
â”‚    â”‚LiveKit  â”‚       â”‚  Redis  â”‚       â”‚   S3    â”‚             â”‚
â”‚    â”‚(Video)  â”‚       â”‚ (Cache) â”‚       â”‚(Storage)â”‚             â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’° Payment Flow Diagram

### Purchase Flow (Mua khÃ³a há»c/buá»•i há»c)

```
Student                    System                    Teacher
   â”‚                         â”‚                         â”‚
   â”‚  1. Click "Buy"         â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
   â”‚                         â”‚                         â”‚
   â”‚  2. Check Credit        â”‚                         â”‚
   â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
   â”‚                         â”‚                         â”‚
   â”‚  3. Confirm Purchase    â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
   â”‚                         â”‚                         â”‚
   â”‚                         â”‚ 4. Deduct Credit        â”‚
   â”‚                         â”‚    (Transaction)        â”‚
   â”‚                         â”‚                         â”‚
   â”‚                         â”‚ 5. Hold Payment         â”‚
   â”‚                         â”‚    (payment_holds)      â”‚
   â”‚                         â”‚                         â”‚
   â”‚  6. Purchase Success    â”‚                         â”‚
   â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚
   â”‚                         â”‚                         â”‚
   â”‚                         â”‚ 7. Notify Teacher       â”‚
   â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                         â”‚                         â”‚
```

### Auto-Release Flow (Sau buá»•i há»c)

```
LiveKit Session            System                    Teacher/Student
      â”‚                      â”‚                              â”‚
      â”‚  1. Session Ends     â”‚                              â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                              â”‚
      â”‚                      â”‚                              â”‚
      â”‚                      â”‚ 2. Calculate Attendance      â”‚
      â”‚                      â”‚    (duration / total)        â”‚
      â”‚                      â”‚                              â”‚
      â”‚                      â”‚ 3. Check >= 20%?             â”‚
      â”‚                      â”‚                              â”‚
      â”‚                      â”œâ”€â”€â”€ YES â”€â”€>                   â”‚
      â”‚                      â”‚                              â”‚
      â”‚                      â”‚ 4. Release to Teacher        â”‚
      â”‚                      â”‚    (70% or 30%)              â”‚
      â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                      â”‚                              â”‚
      â”‚                      â”œâ”€â”€â”€ NO â”€â”€>                    â”‚
      â”‚                      â”‚                              â”‚
      â”‚                      â”‚ 5. Refund to Student         â”‚
      â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                      â”‚                              â”‚
```

---

## ğŸ“ Course Structure Diagram

```
Course (KhÃ³a há»c)
â”‚
â”œâ”€â”€ Basic Info
â”‚   â”œâ”€â”€ Title
â”‚   â”œâ”€â”€ Description
â”‚   â”œâ”€â”€ Duration (hours)
â”‚   â”œâ”€â”€ Total Sessions
â”‚   â””â”€â”€ Teacher
â”‚
â”œâ”€â”€ Pricing
â”‚   â”œâ”€â”€ Price Type (per_session / full_course)
â”‚   â”œâ”€â”€ Price per Session ($1+)
â”‚   â””â”€â”€ Price Full Course ($1+)
â”‚
â”œâ”€â”€ Sessions (Buá»•i há»c)
â”‚   â”œâ”€â”€ Session 1
â”‚   â”‚   â”œâ”€â”€ Title
â”‚   â”‚   â”œâ”€â”€ Date & Time
â”‚   â”‚   â”œâ”€â”€ Duration
â”‚   â”‚   â””â”€â”€ LiveKit Room
â”‚   â”œâ”€â”€ Session 2
â”‚   â””â”€â”€ Session N
â”‚
â”œâ”€â”€ Enrollments (ÄÄƒng kÃ½)
â”‚   â”œâ”€â”€ Student A (Full Course)
â”‚   â”œâ”€â”€ Student B (Per Session)
â”‚   â””â”€â”€ Student C (Full Course)
â”‚
â””â”€â”€ Revenue
    â”œâ”€â”€ Total Earned
    â”œâ”€â”€ Pending (Held)
    â””â”€â”€ Refunded
```

---

## ğŸ¯ Free Talk Room Flow

```
User A (Host)              System              User B, C, D
    â”‚                        â”‚                      â”‚
    â”‚  1. Create Room        â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                        â”‚                      â”‚
    â”‚  2. Generate QR/Link   â”‚                      â”‚
    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
    â”‚                        â”‚                      â”‚
    â”‚  3. Share Link         â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                        â”‚                      â”‚
    â”‚                        â”‚  4. Join Room        â”‚
    â”‚                        â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                        â”‚                      â”‚
    â”‚  5. Video Chat (Max 4) â”‚                      â”‚
    â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                        â”‚                      â”‚
    â”‚  6. User Leaves        â”‚                      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
    â”‚                        â”‚                      â”‚
    â”‚                        â”‚ 7. Check Empty?      â”‚
    â”‚                        â”‚    (count = 0)       â”‚
    â”‚                        â”‚                      â”‚
    â”‚                        â”‚ 8. Auto-Close Room   â”‚
    â”‚                        â”‚                      â”‚
```

---

## ğŸ’³ Database Relationships

```
users (NgÆ°á»i dÃ¹ng)
  â”‚
  â”œâ”€â”€< courses (1:N)
  â”‚     â”‚
  â”‚     â”œâ”€â”€< course_sessions (1:N)
  â”‚     â”‚     â”‚
  â”‚     â”‚     â””â”€â”€< session_purchases (1:N)
  â”‚     â”‚
  â”‚     â””â”€â”€< course_enrollments (1:N)
  â”‚
  â”œâ”€â”€< free_talk_rooms (1:N - as host)
  â”‚     â”‚
  â”‚     â””â”€â”€< free_talk_participants (1:N)
  â”‚
  â”œâ”€â”€< transactions (1:N)
  â”‚
  â”œâ”€â”€< withdrawals (1:N - teachers only)
  â”‚
  â”œâ”€â”€< payment_holds (1:N)
  â”‚
  â””â”€â”€< reviews (1:N - as teacher)
```

---

## ğŸ”„ State Transitions

### Course Status
```
upcoming â†’ ongoing â†’ completed
    â”‚
    â””â”€â”€> cancelled
```

### Session Status
```
scheduled â†’ in_progress â†’ completed
    â”‚
    â””â”€â”€> cancelled
```

### Payment Hold Status
```
held â†’ released (to teacher)
  â”‚
  â””â”€â”€> refunded (to student)
```

### Enrollment Status
```
active â†’ completed
  â”‚
  â””â”€â”€> cancelled (with refund)
```

---

## ğŸ“Š Revenue Distribution

### Scenario 1: Student tá»« Platform
```
Student pays $100
    â”‚
    â”œâ”€â”€> Teacher: $30 (30%)
    â””â”€â”€> Platform: $70 (70%)
```

### Scenario 2: Student tá»« Teacher Referral
```
Student pays $100
    â”‚
    â”œâ”€â”€> Teacher: $70 (70%)
    â””â”€â”€> Platform: $30 (30%)
```

---

## ğŸ¯ Attendance-based Payment

```
Session Duration: 90 minutes

Case 1: Student attends 80 minutes (88%)
    â”œâ”€â”€> >= 20% threshold
    â””â”€â”€> âœ… Payment released to teacher

Case 2: Student attends 15 minutes (16%)
    â”œâ”€â”€> < 20% threshold
    â””â”€â”€> âŒ Refund to student
```

---

## ğŸŒ GeoIP Matching (Free Talk)

```
User Location (IP)
    â”‚
    â”œâ”€â”€> GeoIP Service
    â”‚       â”‚
    â”‚       â””â”€â”€> Country: VN, City: Hanoi
    â”‚
    â””â”€â”€> Find Rooms
            â”‚
            â”œâ”€â”€> Filter: region = VN
            â”œâ”€â”€> Filter: not full (< 4)
            â””â”€â”€> Order: created_at DESC
```

---

## ğŸ”” Notification Flow

```
Event Trigger              System              Recipient
     â”‚                       â”‚                     â”‚
     â”‚  Course Purchase      â”‚                     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚
     â”‚                       â”‚                     â”‚
     â”‚                       â”‚ Create Notification â”‚
     â”‚                       â”‚                     â”‚
     â”‚                       â”‚ Send Email          â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                     â”‚
     â”‚                       â”‚ Send Push           â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                     â”‚
     â”‚                       â”‚ Socket Event        â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                       â”‚                     â”‚
```

---

## ğŸš€ Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Load Balancer (Nginx)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚Frontend â”‚      â”‚Backend  â”‚
   â”‚(Next.js)â”‚      â”‚(NestJS) â”‚
   â”‚  :3001  â”‚      â”‚  :3000  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚PostgreSQLâ”‚     â”‚  Redis  â”‚     â”‚LiveKit  â”‚
   â”‚  :5432  â”‚     â”‚  :6379  â”‚     â”‚  :7880  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“± Mobile App Flow (Future)

```
Mobile App
    â”‚
    â”œâ”€â”€> Scan QR Code
    â”‚       â”‚
    â”‚       â”œâ”€â”€> Course QR â†’ Enroll
    â”‚       â””â”€â”€> Room QR â†’ Join Free Talk
    â”‚
    â”œâ”€â”€> Push Notifications
    â”‚       â”‚
    â”‚       â”œâ”€â”€> Session Reminder
    â”‚       â”œâ”€â”€> Payment Received
    â”‚       â””â”€â”€> Refund Processed
    â”‚
    â””â”€â”€> Offline Mode
            â”‚
            â””â”€â”€> Cache course materials
```

---

**Use these diagrams to understand the system flow!** ğŸ“Š
