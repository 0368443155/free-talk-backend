version: '3.8'
services:
  # Core LiveKit SFU Server
  livekit:
    image: livekit/livekit-server:latest
    command: --config /etc/livekit.yaml
    restart: unless-stopped
    ports:
      - "7880:7880"     # WebSocket signaling port
      - "7881:7881"     # HTTP API port  
      - "7882:7882/udp" # UDP media relay port
    volumes:
      - ./livekit.yaml:/etc/livekit.yaml
    environment:
      LIVEKIT_KEYS: "devkey: devsecret"
    networks:
      - livekit

  # Redis for LiveKit (scaling & room state)
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "6380:6379"  # Use different port to avoid conflicts
    command: redis-server --appendonly yes
    volumes:
      - livekit_redis_data:/data
    networks:
      - livekit

  # TURN Server for NAT traversal (Coturn)
  coturn:
    image: coturn/coturn:latest
    restart: unless-stopped
    ports:
      - "3478:3478/udp"     # STUN/TURN UDP
      - "3478:3478/tcp"     # STUN/TURN TCP  
      - "5349:5349/udp"     # STUNS/TURNS UDP
      - "5349:5349/tcp"     # STUNS/TURNS TCP
      - "49152-65535:49152-65535/udp"  # Media relay range
    environment:
      - REALM=localhost
      - USERNAME=livekit
      - PASSWORD=turnpassword
      - MIN_PORT=49152
      - MAX_PORT=65535
    command: |
      sh -c "echo 'listening-port=3478
      tls-listening-port=5349
      fingerprint
      lt-cred-mech
      use-auth-secret
      static-auth-secret=turnpassword
      realm=localhost
      total-quota=100
      bps-capacity=0
      stale-nonce
      no-multicast-peers
      no-cli
      no-tlsv1
      no-tlsv1_1
      no-stdout-log' > /etc/turnserver.conf && turnserver -c /etc/turnserver.conf"
    networks:
      - livekit

networks:
  livekit:
    driver: bridge

volumes:
  livekit_redis_data: